#!/usr/bin/env zsh
#
# Usage: add-nodejs-cli-tool <npm-pkg> [<command-name>]

set -eu

declare -r pkg=$1 ; shift
cd ~/.dotfiles/tag-nodejs/local/libexec/nodejs-cli-tools

mkdir -p "$pkg"
cd "$pkg"

echo '{"license": "MIT"}' > package.json
echo $'*\n!package.json\n!.gitignore' > .gitignore

rcup -K

cd ~/.local/libexec/nodejs-cli-tools/"$pkg"

yarn add "$pkg"

declare -r yarn_bin="$(yarn bin)"
declare -aUr maybe_bin=(
"$@"
"$pkg"
"$(basename "$pkg" -cli)"
)

declare foundit=0

function makescript {
  local pkg="$1"; shift
  local bin="$1"; shift
  local stub=~/.dotfiles/tag-nodejs/bin/"$bin"

  echo -e "#!/usr/bin/env zsh\nset -eu\nif [ -f 'package.json' ] && [ -x 'node_modules/.bin/${bin}' ]; then\n\texec 'node_modules/.bin/${bin}' \"\$@\"\nelse\n\texec \"\${HOME}/.local/libexec/nodejs-cli-tools/${pkg}/node_modules/.bin/${bin}\" \"\$@\"\nfi" > "$stub"
  chmod +x "$stub"
}

for bin in "${maybe_bin[@]}"; do
  if [ -x "${yarn_bin}/${bin}" ]; then

    makescript "$pkg" "$bin"

    rcup -K

    foundit=1

    break
  fi
done

if ! (( foundit )); then
  echo "Unable to find executable for $pkg"
fi

# EOF
